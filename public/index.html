<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SCADA Dashboard</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    /* ================= Base ================= */
    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 16px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    .wrap {
      max-width: 1100px;
      width: 100%;
      margin: 0 auto;
      overflow-x: hidden;
    }

    h1 { margin: 0; font-size: 20px; }

    .title {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      width: 100%;
    }

    .card {
      flex: 1 1 260px;
      min-width: 0;
      padding: 14px;
      border-radius: 14px;
    }

    label { font-size: 12px; opacity: .8; }
    input, button {
      width: 100%;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid;
      background: transparent;
      color: inherit;
    }

    button { cursor: pointer; }

    .grid2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .actions {
      display: flex;
      gap: 10px;
      margin-top: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    .kpi {
      font-size: 28px;
      font-weight: 700;
    }

    .chartCard {
      margin-top: 12px;
      padding: 14px;
      border-radius: 14px;
      width: 100%;
      overflow: hidden;
    }

    canvas {
      width: 100% !important;
      height: 420px !important;
    }

    .statusDot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 6px;
    }

    /* ================= SCADA THEME ================= */
    :root {
      --bg: #f5f7fb;
      --panel: #ffffff;
      --stroke: rgba(0,0,0,.15);
      --text: #0b1220;
      --muted: rgba(0,0,0,.6);
      --accent: #2563eb;
      --ok: #16a34a;
      --warn: #f59e0b;
      --bad: #dc2626;
    }

    [data-theme="dark"] {
      --bg: #05070b;
      --panel: rgba(10,14,22,.92);
      --stroke: rgba(45,255,178,.25);
      --text: #d9ffe9;
      --muted: rgba(217,255,233,.7);
      --accent: #2dffb2;
      --ok: #2dffb2;
      --warn: #ffb020;
      --bad: #ff3b5c;
    }

    body {
      background: var(--bg);
      color: var(--text);
    }

    .card, .chartCard {
      background: var(--panel);
      border: 1px solid var(--stroke);
    }

    .muted { color: var(--muted); font-size: 12px; }

    button {
      border-color: var(--stroke);
      background: rgba(0,0,0,.06);
    }

    [data-theme="dark"] button {
      box-shadow: 0 0 18px rgba(45,255,178,.15);
    }

    .ok { background: var(--ok); }
    .warn { background: var(--warn); }
    .bad { background: var(--bad); }

    /* ================= Responsive ================= */

    /* Tablet */
    @media (max-width: 900px) {
      .row {
        display: grid;
        grid-template-columns: 1fr 1fr;
      }
      canvas { height: 360px !important; }
    }

    /* Mobile */
    @media (max-width: 600px) {
      body { padding: 10px; }

      .title {
        flex-direction: column;
        align-items: flex-start;
      }

      .row {
        grid-template-columns: 1fr;
      }

      .grid2 {
        grid-template-columns: 1fr;
      }

      .actions {
        flex-direction: column;
        align-items: stretch;
      }

      canvas {
        height: 300px !important;
      }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="title">
      <h1>SCADA Dashboard</h1>

      <div style="display:flex; gap:10px; align-items:center;">
        <button id="themeBtn">ðŸŒ™ Dark</button>
        <div class="muted">
          <span id="healthDot" class="statusDot"></span>
          <span id="healthText">checkingâ€¦</span>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="card">
        <label>device_id</label>
        <input id="deviceId" value="dht22-01" />
      </div>

      <div class="card">
        <div class="grid2">
          <div>
            <label>à¸¢à¹‰à¸­à¸™à¸«à¸¥à¸±à¸‡ (minutes)</label>
            <input id="minutes" type="number" value="180">
          </div>
          <div>
            <label>à¸£à¸µà¹€à¸Ÿà¸£à¸Š (à¸§à¸´à¸™à¸²à¸—à¸µ)</label>
            <input id="refreshSec" type="number" value="10">
          </div>
        </div>

        <div class="actions">
          <button id="btnLoad">à¹‚à¸«à¸¥à¸”/à¸£à¸µà¹€à¸Ÿà¸£à¸Š</button>
          <button id="btnToggle">à¸«à¸¢à¸¸à¸” auto</button>
          <div id="lastUpdate" class="muted">â€”</div>
        </div>
      </div>

      <div class="card">
        <div class="muted">à¸„à¹ˆà¸²à¸¥à¹ˆà¸²à¸ªà¸¸à¸”</div>
        <div class="kpi" id="latestTemp">â€” Â°C</div>
        <div class="kpi" id="latestHum">â€” %</div>
        <div class="muted" id="latestTs">â€”</div>
      </div>
    </div>

    <div class="chartCard">
      <canvas id="chart"></canvas>
      <div class="muted" id="note">â€”</div>
    </div>
  </div>

  <!-- ===== JS ===== -->
  <script src="https://cdn.jsdelivr.net/npm/date-fns@3.6.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0"></script>

  <script>
    const $ = id => document.getElementById(id);
    let chart, timer;

    async function checkHealth(){
      try{
        const r = await fetch("/health");
        $("healthDot").className = "statusDot " + (r.ok ? "ok":"bad");
        $("healthText").textContent = r.ok ? "backend ok":"error";
      }catch{
        $("healthDot").className = "statusDot bad";
        $("healthText").textContent = "offline";
      }
    }

    async function refreshOnce(){
      await checkHealth();
      $("lastUpdate").textContent = "à¸­à¸±à¸›à¹€à¸”à¸•: " + new Date().toLocaleTimeString();
    }

    function startAuto(){
      stopAuto();
      timer = setInterval(refreshOnce, Number($("refreshSec").value)*1000);
      $("btnToggle").textContent = "à¸«à¸¢à¸¸à¸” auto";
    }
    function stopAuto(){
      if(timer) clearInterval(timer);
      timer=null;
      $("btnToggle").textContent = "à¹€à¸£à¸´à¹ˆà¸¡ auto";
    }

    $("btnToggle").onclick = ()=> timer ? stopAuto():startAuto();
    $("btnLoad").onclick = refreshOnce;

    /* Theme */
    const themeBtn = $("themeBtn");
    function applyTheme(t){
      document.documentElement.setAttribute("data-theme",t);
      localStorage.setItem("theme",t);
      themeBtn.textContent = t==="dark"?"â˜€ï¸ Light":"ðŸŒ™ Dark";
    }
    applyTheme(localStorage.getItem("theme")||"dark");
    themeBtn.onclick = ()=>applyTheme(
      document.documentElement.getAttribute("data-theme")==="dark"?"light":"dark"
    );

    refreshOnce();
    startAuto();
  </script>
</body>
</html>
