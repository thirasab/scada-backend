<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SCADA Dashboard</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- Time adapter -->
  <script src="https://cdn.jsdelivr.net/npm/date-fns@3.6.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0"></script>

  <style>
    :root { color-scheme: light dark; }

    :root{
      --bg:#ffffff; --fg:#111827;
      --card:rgba(17,24,39,.04);
      --border:rgba(127,127,127,.25);
      --btn:rgba(127,127,127,.12);
    }
    :root[data-theme="dark"]{
      --bg:#0b1220; --fg:#e5e7eb;
      --card:rgba(255,255,255,.06);
      --border:rgba(255,255,255,.18);
      --btn:rgba(255,255,255,.10);
    }

    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      margin:0;padding:16px;
      background:var(--bg);color:var(--fg);
    }

    .wrap{max-width:1100px;margin:0 auto}
    .title{display:flex;justify-content:space-between;align-items:center}
    h1{margin:0;font-size:20px}

    .row{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
    .card,.chartCard{
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px 14px;
      background:var(--card);
      flex:1 1 260px;
      min-width:260px;
    }

    label{font-size:12px;opacity:.8}
    input,select,button{
      width:100%;padding:10px;
      border-radius:10px;
      border:1px solid rgba(127,127,127,.35);
      background:transparent;color:inherit;
    }
    button{cursor:pointer;background:var(--btn)}
    button:hover{filter:brightness(1.05)}

    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:720px){.grid2{grid-template-columns:1fr}}

    .kpi{font-size:26px;font-weight:700}
    .kpi small{font-size:14px;opacity:.8}

    canvas{width:100%!important;height:420px!important}

    .muted{opacity:.7;font-size:12px}
    .statusDot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:6px;background:#999}
    .ok{background:#22c55e}
    .bad{background:#ef4444}
  </style>
</head>

<body>
<div class="wrap">

  <div class="title">
    <h1>SCADA Dashboard</h1>
    <div style="display:flex;gap:10px;align-items:center">
      <button id="themeBtn">üåô Dark</button>
      <div class="muted">
        <span id="healthDot" class="statusDot"></span>
        <span id="healthText">checking‚Ä¶</span>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="card">
      <label>device_id</label>
      <input id="deviceId" value="dht22-01">
    </div>

    <div class="card">
      <div class="grid2">
        <div>
          <label>‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏£‡∏≤‡∏ü</label>
          <select id="mode">
            <option value="minutes">‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ô‡∏≤‡∏ó‡∏µ</option>
            <option value="range">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‚Äì‡πÄ‡∏ß‡∏•‡∏≤</option>
          </select>
        </div>
        <div>
          <label>refresh (‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)</label>
          <input id="refreshSec" type="number" value="10" min="2">
        </div>
      </div>

      <div class="grid2" style="margin-top:10px">
        <div id="minutesBox">
          <label>minutes</label>
          <input id="minutes" type="number" value="180">
        </div>
        <div id="rangeBox" style="display:none">
          <label>From</label>
          <input id="fromDT" type="datetime-local">
          <label style="margin-top:6px">To</label>
          <input id="toDT" type="datetime-local">
        </div>
      </div>

      <div style="display:flex;gap:10px;margin-top:10px;flex-wrap:wrap">
        <button id="btnLoad">‡πÇ‡∏´‡∏•‡∏î</button>
        <button id="btnToggle">‡∏´‡∏¢‡∏∏‡∏î auto</button>
        <div class="muted" id="lastUpdate">‚Äî</div>
      </div>
    </div>

    <div class="card">
      <div class="muted">‡∏Ñ‡πà‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
      <div class="kpi" id="latestTemp">‚Äî <small>¬∞C</small></div>
      <div class="kpi" id="latestHum">‚Äî <small>%</small></div>
      <div class="muted" id="latestTs">‚Äî</div>
    </div>
  </div>

  <div style="margin-top:12px" class="chartCard">
    <canvas id="chart"></canvas>
    <div class="muted" id="note">‚Äî</div>
  </div>

</div>

<script>
const $=id=>document.getElementById(id);
let chart,timer;

function setTheme(t){
  document.documentElement.setAttribute("data-theme",t);
  localStorage.setItem("theme",t);
  $("themeBtn").textContent=t==="dark"?"‚òÄÔ∏è Light":"üåô Dark";
}
setTheme(localStorage.getItem("theme")||
  (matchMedia("(prefers-color-scheme:dark)").matches?"dark":"light")
);
$("themeBtn").onclick=()=>setTheme(
  document.documentElement.getAttribute("data-theme")==="dark"?"light":"dark"
);

async function checkHealth(){
  try{
    const r=await fetch("/health");
    $("healthDot").className="statusDot "+(r.ok?"ok":"bad");
    $("healthText").textContent=r.ok?"backend ok":"error";
  }catch{
    $("healthDot").className="statusDot bad";
    $("healthText").textContent="offline";
  }
}

async function loadLatest(id){
  const r=await fetch(`/api/latest?device_id=${id}`);
  const x=await r.json();
  if(!x)return;
  $("latestTemp").innerHTML=`${(+x.temp_c).toFixed(2)} <small>¬∞C</small>`;
  $("latestHum").innerHTML=`${(+x.hum_pct).toFixed(2)} <small>%</small>`;
  $("latestTs").textContent=new Date(x.ts).toLocaleString();
}

async function loadSeries(id){
  if($("mode").value==="minutes"){
    const r=await fetch(`/api/history?device_id=${id}&minutes=${$("minutes").value}`);
    return r.json();
  }
  const from=new Date($("fromDT").value).toISOString();
  const to=new Date($("toDT").value).toISOString();
  const r=await fetch(`/api/range?device_id=${id}&from=${from}&to=${to}`);
  return r.json();
}

function draw(arr){
  const labels=arr.map(r=>new Date(r.ts));
  const t=arr.map(r=>r.temp_c);
  const h=arr.map(r=>r.hum_pct);

  if(chart){
    chart.data.labels=labels;
    chart.data.datasets[0].data=t;
    chart.data.datasets[1].data=h;
    return chart.update();
  }

  chart=new Chart($("chart"),{
    type:"line",
    data:{
      labels,
      datasets:[
        {label:"Temp ¬∞C",data:t,yAxisID:"y1"},
        {label:"Hum %",data:h,yAxisID:"y2"}
      ]
    },
    options:{
      interaction:{mode:"index",intersect:false},
      scales:{
        x:{type:"time"},
        y1:{position:"left"},
        y2:{position:"right",grid:{drawOnChartArea:false}}
      }
    }
  });
}

async function refresh(){
  const id=$("deviceId").value;
  await checkHealth();
  await loadLatest(id);
  const arr=await loadSeries(id);
  draw(arr);
  $("lastUpdate").textContent=new Date().toLocaleTimeString();
  $("note").textContent=`points: ${arr.length}`;
}

$("mode").onchange=()=>{
  $("minutesBox").style.display=$("mode").value==="minutes"?"":"none";
  $("rangeBox").style.display=$("mode").value==="range"?"":"none";
};

$("btnLoad").onclick=refresh;
$("btnToggle").onclick=()=>{
  if(timer){clearInterval(timer);timer=null;$("btnToggle").textContent="‡πÄ‡∏£‡∏¥‡πà‡∏° auto";}
  else{timer=setInterval(refresh,$("refreshSec").value*1000);$("btnToggle").textContent="‡∏´‡∏¢‡∏∏‡∏î auto";}
};

const now=new Date();
$("toDT").value=now.toISOString().slice(0,16);
$("fromDT").value=new Date(now-3*3600000).toISOString().slice(0,16);

refresh().then(()=>timer=setInterval(refresh,$("refreshSec").value*1000));
</script>
</body>
</html>
