<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SCADA Dashboard</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    /* =====================
       GLOBAL FIX (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç)
       ===================== */
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 16px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    .wrap {
      width: 100%;
      max-width: 1100px;
      margin: 0 auto;
      overflow-x: hidden; /* ‚≠ê ‡∏Å‡∏±‡∏ô‡∏•‡πâ‡∏ô‡∏Ç‡∏≠‡∏ö */
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      width: 100%;
    }

    /* =====================
       CARD / LAYOUT
       ===================== */
    .card {
      flex: 1 1 260px;
      min-width: 0;               /* ‚≠ê FIX flex overflow */
      padding: 12px 14px;
      border-radius: 12px;
    }

    .chartCard {
      width: 100%;
      padding: 12px 14px;
      border-radius: 12px;
      overflow: hidden;           /* ‚≠ê FIX canvas ‡∏î‡∏±‡∏ô‡∏Ç‡∏≠‡∏ö */
    }

    canvas {
      max-width: 100% !important;
      height: 420px !important;
    }

    input {
      width: 100%;
      max-width: 100%;
      padding: 10px;
      border-radius: 10px;
    }

    button {
      padding: 10px 12px;
      border-radius: 10px;
      cursor: pointer;
    }

    label {
      font-size: 12px;
      margin-bottom: 6px;
      display: block;
      opacity: .8;
    }

    h1 {
      margin: 0;
      font-size: 20px;
    }

    .muted {
      font-size: 12px;
      opacity: .75;
    }

    .kpi {
      font-size: 26px;
      font-weight: 700;
      line-height: 1.1;
    }

    .kpi small {
      font-size: 14px;
    }

    .grid2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    @media (max-width: 720px) {
      .grid2 {
        grid-template-columns: 1fr;
      }
    }

    /* =====================
       STATUS DOT
       ===================== */
    .statusDot {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 6px;
    }

    /* =====================
       SCADA THEME
       ===================== */
    :root {
      --bg: #f6f7fb;
      --panel: #ffffff;
      --border: rgba(0,0,0,.15);
      --text: #0b1220;
      --muted: rgba(0,0,0,.6);
      --ok: #16a34a;
      --warn: #f59e0b;
      --bad: #dc2626;
    }

    [data-theme="dark"] {
      --bg: #05070b;
      --panel: #0b1220;
      --border: rgba(45,255,178,.25);
      --text: #d9ffe9;
      --muted: rgba(217,255,233,.65);
      --ok: #2dffb2;
      --warn: #ffb020;
      --bad: #ff3b5c;
    }

    body {
      background: var(--bg);
      color: var(--text);
    }

    .card, .chartCard {
      background: var(--panel);
      border: 1px solid var(--border);
    }

    input, button {
      border: 1px solid var(--border);
      background: transparent;
      color: inherit;
    }

    .ok   { background: var(--ok); }
    .warn { background: var(--warn); }
    .bad  { background: var(--bad); }
  </style>
</head>

<body>
<div class="wrap">

  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px">
    <h1>SCADA Dashboard</h1>

    <div style="display:flex; gap:10px; align-items:center">
      <button id="themeBtn">üåô Dark</button>
      <div class="muted">
        <span id="healthDot" class="statusDot"></span>
        <span id="healthText">checking‚Ä¶</span>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="card">
      <label>device_id</label>
      <input id="deviceId" value="dht22-01" />
    </div>

    <div class="card">
      <div class="grid2">
        <div>
          <label>‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á (minutes)</label>
          <input id="minutes" type="number" value="180" />
        </div>
        <div>
          <label>‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä (‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)</label>
          <input id="refreshSec" type="number" value="10" />
        </div>
      </div>

      <div style="margin-top:12px; display:flex; gap:8px">
        <button id="btnLoad">‡πÇ‡∏´‡∏•‡∏î/‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
        <button id="btnToggle">‡∏´‡∏¢‡∏∏‡∏î auto</button>
      </div>
    </div>

    <div class="card">
      <div class="muted">‡∏Ñ‡πà‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
      <div class="kpi" id="latestTemp">‚Äî <small>¬∞C</small></div>
      <div class="kpi" id="latestHum">‚Äî <small>%</small></div>
      <div class="muted" id="latestTs">‚Äî</div>
    </div>
  </div>

  <div style="height:12px"></div>

  <div class="chartCard">
    <canvas id="chart"></canvas>
    <div class="muted" id="note" style="margin-top:8px">‚Äî</div>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/date-fns@3.6.0"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0"></script>

<script>
  const $ = id => document.getElementById(id);
  let chart, timer;

  async function checkHealth() {
    try {
      const r = await fetch("/health");
      $("healthDot").className = "statusDot " + (r.ok ? "ok" : "bad");
      $("healthText").textContent = r.ok ? "backend ok" : "backend error";
    } catch {
      $("healthDot").className = "statusDot bad";
      $("healthText").textContent = "offline";
    }
  }

  async function refresh() {
    const id = $("deviceId").value;
    const min = $("minutes").value;

    await checkHealth();

    const l = await fetch(`/api/latest?device_id=${id}`).then(r=>r.json());
    if (l) {
      $("latestTemp").innerHTML = `${l.temp_c?.toFixed(2)} <small>¬∞C</small>`;
      $("latestHum").innerHTML  = `${l.hum_pct?.toFixed(2)} <small>%</small>`;
      $("latestTs").textContent = new Date(l.ts).toLocaleString();
    }

    const h = await fetch(`/api/history?device_id=${id}&minutes=${min}`).then(r=>r.json());
    const labels = h.map(x=>new Date(x.ts));
    const temp = h.map(x=>x.temp_c);
    const hum  = h.map(x=>x.hum_pct);

    if (!chart) {
      chart = new Chart($("chart"), {
        type: "line",
        data: {
          labels,
          datasets: [
            { label: "Temperature (¬∞C)", data: temp, borderColor: "#2dffb2", tension:.3 },
            { label: "Humidity (%)", data: hum,  borderColor: "#ffb020", tension:.3 }
          ]
        }
      });
    } else {
      chart.data.labels = labels;
      chart.data.datasets[0].data = temp;
      chart.data.datasets[1].data = hum;
      chart.update();
    }
  }

  function startAuto() {
    clearInterval(timer);
    timer = setInterval(refresh, Math.max(2,$("refreshSec").value)*1000);
    $("btnToggle").textContent = "‡∏´‡∏¢‡∏∏‡∏î auto";
  }

  function stopAuto() {
    clearInterval(timer);
    timer = null;
    $("btnToggle").textContent = "‡πÄ‡∏£‡∏¥‡πà‡∏° auto";
  }

  $("btnLoad").onclick = refresh;
  $("btnToggle").onclick = ()=> timer ? stopAuto() : startAuto();

  // Theme
  const themeBtn = $("themeBtn");
  function setTheme(t){
    document.documentElement.setAttribute("data-theme", t);
    localStorage.setItem("theme", t);
    themeBtn.textContent = t==="dark" ? "‚òÄÔ∏è Light" : "üåô Dark";
  }
  setTheme(localStorage.getItem("theme") || "dark");
  themeBtn.onclick = ()=> setTheme(
    document.documentElement.getAttribute("data-theme")==="dark"?"light":"dark"
  );

  refresh().then(startAuto);
</script>
</body>
</html>
