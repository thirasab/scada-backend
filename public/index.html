<!doctype html>
<html lang="th" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Industrial SCADA Dashboard</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    /* =====================================================
       GLOBAL + FIX OVERFLOW
       ===================================================== */
    * { box-sizing: border-box; }
    html, body { width:100%; }
    body {
      margin:0;
      padding:16px;
      overflow-x:hidden;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    .wrap{
      max-width:1200px;
      width:100%;
      margin:0 auto;
      overflow-x:hidden;
    }

    /* =====================================================
       RESPONSIVE GRID (แทน flex)
       ===================================================== */
    .row{
      display:grid;
      grid-template-columns:repeat(12,1fr);
      gap:12px;
      width:100%;
    }

    .card{ grid-column: span 4; min-width:0; }
    .card.control{ grid-column: span 5; }
    .card.kpi{ grid-column: span 3; }

    @media(max-width:1100px){
      .card{ grid-column: span 6; }
      .card.control{ grid-column: span 6; }
      .card.kpi{ grid-column: span 12; }
    }

    @media(max-width:720px){
      .card{ grid-column: span 12; }
      body{ padding:12px; }
    }

    /* =====================================================
       BASE COMPONENT
       ===================================================== */
    h1{ margin:0; font-size:20px; letter-spacing:.6px; }
    label{ font-size:12px; margin-bottom:6px; display:block; }
    .muted{ font-size:12px; }

    input{
      width:100%;
      padding:10px;
      border-radius:8px;
      border:1px solid;
      background:transparent;
      color:inherit;
    }

    button{
      padding:10px 12px;
      border-radius:8px;
      border:1px solid;
      background:transparent;
      cursor:pointer;
      white-space:nowrap;
    }

    .kpiValue{
      font-size:28px;
      font-weight:800;
      margin-top:6px;
    }

    .chartCard{
      margin-top:14px;
      padding:12px;
      border-radius:12px;
      overflow:hidden;
    }

    canvas{
      width:100% !important;
      height:420px !important;
      max-width:100%;
    }

    /* =====================================================
       INDUSTRIAL SCADA THEME
       ===================================================== */
    :root{
      --bg:#04060a;
      --panel:#0a0e16;
      --panel2:#0a0e16cc;
      --border:#2dffb244;
      --text:#d9ffe9;
      --muted:#9fdcc6;
      --accent:#2dffb2;
      --warn:#ffb020;
      --shadow:0 14px 40px rgba(0,0,0,.6);
    }

    body{
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(45,255,178,.06), transparent 60%),
        var(--bg);
      color:var(--text);
    }

    .card,.chartCard{
      background:linear-gradient(180deg,var(--panel),var(--panel2));
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      backdrop-filter:blur(8px);
    }

    input,button{ border-color:var(--border); }
    .muted{ color:var(--muted); }

    /* =====================================================
       HEADER
       ===================================================== */
    .header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:10px;
    }

    .statusDot{
      width:10px;
      height:10px;
      border-radius:50%;
      background:#999;
      display:inline-block;
      margin-right:6px;
    }
    .ok{ background:var(--accent); box-shadow:0 0 12px var(--accent); }
    .bad{ background:#ff3b5c; box-shadow:0 0 12px #ff3b5c; }
  </style>
</head>

<body>
<div class="wrap">

  <!-- HEADER -->
  <div class="header">
    <h1>SCADA Dashboard</h1>
    <div class="muted">
      <span id="healthDot" class="statusDot"></span>
      <span id="healthText">checking…</span>
    </div>
  </div>

  <!-- CONTROL ROW -->
  <div class="row">
    <div class="card">
      <label>device_id</label>
      <input id="deviceId" value="dht22-01">
    </div>

    <div class="card control">
      <label>ย้อนหลัง (minutes)</label>
      <input id="minutes" type="number" value="180">

      <label style="margin-top:10px">เลือกช่วงเวลา (From – To)</label>
      <input id="fromTime" type="datetime-local">
      <input id="toTime" type="datetime-local" style="margin-top:6px">

      <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
        <button id="btnLoad">โหลด</button>
        <button id="btnToggle">หยุด auto</button>
        <span class="muted" id="lastUpdate">—</span>
      </div>
    </div>

    <div class="card kpi">
      <div class="muted">ค่าล่าสุด</div>
      <div class="kpiValue" id="latestTemp">— °C</div>
      <div class="kpiValue" id="latestHum">— %</div>
      <div class="muted" id="latestTs">—</div>
    </div>
  </div>

  <!-- CHART -->
  <div class="chartCard">
    <canvas id="chart"></canvas>
    <div class="muted" id="note">—</div>
  </div>

</div>

<!-- DATE ADAPTER -->
<script src="https://cdn.jsdelivr.net/npm/date-fns@3.6.0"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0"></script>

<script>
const $ = id => document.getElementById(id);
let chart=null, timer=null;

/* ------------------ API ------------------ */
async function checkHealth(){
  try{
    const r=await fetch("/health",{cache:"no-store"});
    $("healthDot").className="statusDot "+(r.ok?"ok":"bad");
    $("healthText").textContent=r.ok?"backend ok":"backend error";
  }catch{
    $("healthDot").className="statusDot bad";
    $("healthText").textContent="offline";
  }
}

async function loadLatest(device){
  const r=await fetch(`/api/latest?device_id=${device}`);
  const x=await r.json();
  if(!x)return;
  $("latestTemp").textContent=`${(+x.temp_c).toFixed(2)} °C`;
  $("latestHum").textContent=`${(+x.hum_pct).toFixed(2)} %`;
  $("latestTs").textContent=new Date(x.ts).toLocaleString();
}

async function loadHistory(device,minutes){
  const r=await fetch(`/api/history?device_id=${device}&minutes=${minutes}`);
  return await r.json();
}

async function loadRange(device,from,to){
  const r=await fetch(`/api/range?device_id=${device}&from=${from}&to=${to}`);
  return await r.json();
}

/* ------------------ CHART ------------------ */
function drawChart(rows){
  const labels=rows.map(r=>new Date(r.ts));
  const temp=rows.map(r=>r.temp_c);
  const hum =rows.map(r=>r.hum_pct);

  if(chart){
    chart.data.labels=labels;
    chart.data.datasets[0].data=temp;
    chart.data.datasets[1].data=hum;
    chart.update();
    return;
  }

  chart=new Chart($("chart"),{
    type:"line",
    data:{
      labels,
      datasets:[
        {label:"Temp °C",data:temp,borderColor:"#2dffb2",borderWidth:2,pointRadius:0},
        {label:"Hum %", data:hum ,borderColor:"#ffb020",borderWidth:2,pointRadius:0}
      ]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      scales:{
        x:{type:"time"},
        y:{beginAtZero:false}
      }
    }
  });
}

/* ------------------ REFRESH ------------------ */
async function refresh(){
  const device=$("deviceId").value;
  const from=$("fromTime").value;
  const to=$("toTime").value;

  await checkHealth();
  await loadLatest(device);

  let rows;
  if(from && to){
    stopAuto();
    rows=await loadRange(device,from,to);
  }else{
    rows=await loadHistory(device,$("minutes").value);
  }

  drawChart(rows);
  $("lastUpdate").textContent=new Date().toLocaleTimeString();
  $("note").textContent=`ข้อมูล ${rows.length} จุด`;
}

function startAuto(){
  stopAuto();
  timer=setInterval(refresh,10000);
  $("btnToggle").textContent="หยุด auto";
}
function stopAuto(){
  if(timer)clearInterval(timer);
  timer=null;
  $("btnToggle").textContent="เริ่ม auto";
}

$("btnLoad").onclick=refresh;
$("btnToggle").onclick=()=>timer?stopAuto():startAuto();

refresh(); startAuto();
</script>
</body>
</html>
