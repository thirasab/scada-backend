<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SCADA Dashboard</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    /* ===== Foundation / no overflow ===== */
    * { box-sizing: border-box; }
    :root { color-scheme: light dark; }

    body {
      margin: 0;
      padding: 16px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    .wrap {
      width: 100%;
      max-width: 1100px;
      margin: 0 auto;
      overflow-x: hidden;
    }

    /* ===== Header ===== */
    .title {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      margin: 0 0 12px 0;
    }
    h1 { margin: 0; font-size: 20px; letter-spacing: .6px; }

    .headerRight {
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap: wrap;
    }

    .muted { opacity: 1; font-size: 12px; }

    /* ===== Cards layout (desktop default) ===== */
    .row {
      display:flex;
      gap: 12px;
      flex-wrap: wrap;
      width: 100%;
    }

    .card {
      border-radius: 14px;
      padding: 12px 14px;
      flex: 1 1 260px;
      min-width: 0; /* important: prevent flex overflow */
    }

    label { font-size: 12px; opacity:.85; display:block; margin-bottom:6px; }

    input, select {
      width: 100%;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid;
      background: transparent;
      color: inherit;
      outline: none;
      font-size: 16px; /* prevent iOS zoom */
    }

    button {
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid;
      background: rgba(127,127,127,.12);
      color: inherit;
      cursor: pointer;
      font-size: 16px;
    }
    button:hover { filter: brightness(1.06); }

    .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }

    .actions {
      display:flex;
      gap: 10px;
      margin-top: 12px;
      align-items:center;
      flex-wrap: wrap;
    }
    .actions #lastUpdate { flex: 1 1 auto; min-width: 140px; }

    .kpi {
      font-size: 28px;
      font-weight: 800;
      line-height: 1.05;
      margin-top: 8px;
      font-variant-numeric: tabular-nums;
    }
    .kpi small { font-size: 14px; font-weight: 700; opacity:.9; }

    .chartCard {
      margin-top: 12px;
      padding: 12px 14px;
      border-radius: 14px;
      width: 100%;
      overflow: hidden;
    }
    canvas { width: 100% !important; height: 420px !important; max-width: 100% !important; }

    .statusDot { display:inline-block; width:10px; height:10px; border-radius:50%; margin-right:6px; background:#999; vertical-align:middle;}

    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }

    /* ===== Quick device chips ===== */
    .quick{
      display:flex;
      gap:8px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    .chip{
      width: auto;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid;
      background: rgba(0,0,0,.08);
      font-weight: 800;
      letter-spacing: .2px;
    }

    /* =========================
       SCADA THEME (Light + Dark)
       ========================= */
    :root{
      --bg: #f6f7fb;
      --panel: rgba(255,255,255,.78);
      --panel2: rgba(255,255,255,.58);
      --stroke: rgba(17,24,39,.18);
      --text: #0b1220;
      --muted2: rgba(11,18,32,.70);

      --accent: #2563eb;
      --ok2: #16a34a;
      --warn2: #f59e0b;
      --bad2: #dc2626;

      --glow: transparent;
      --shadow: 0 8px 28px rgba(0,0,0,.08);
      --tap: 52px;
      --radius: 16px;
    }

    [data-theme="dark"]{
      --bg: #05070b;
      --panel: rgba(10,14,22,.90);
      --panel2: rgba(10,14,22,.68);
      --stroke: rgba(45,255,178,.22);
      --text: #d9ffe9;
      --muted2: rgba(217,255,233,.72);

      --accent: #2dffb2;
      --ok2: #2dffb2;
      --warn2: #ffb020;
      --bad2: #ff3b5c;

      --glow: 0 0 18px rgba(45,255,178,.20), 0 0 42px rgba(45,255,178,.10);
      --shadow: 0 14px 40px rgba(0,0,0,.55);
    }

    body{
      background: radial-gradient(1200px 700px at 20% 10%, rgba(45,255,178,.05), transparent 60%),
                  radial-gradient(900px 600px at 80% 20%, rgba(255,176,32,.04), transparent 55%),
                  var(--bg);
      color: var(--text);
    }

    .muted{ color: var(--muted2); }

    .card, .chartCard{
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
      backdrop-filter: blur(8px);
    }

    input, select{
      border-color: var(--stroke);
      background: rgba(0,0,0,.08);
    }
    [data-theme="dark"] input,
    [data-theme="dark"] select{
      background: rgba(0,0,0,.22);
    }

    button{
      border-color: var(--stroke);
      background: rgba(0,0,0,.06);
    }
    [data-theme="dark"] button{
      background: rgba(0,0,0,.28);
      box-shadow: var(--glow);
    }

    .chip{ border-color: var(--stroke); }
    [data-theme="light"] .chip{ background: rgba(0,0,0,.04); }

    .ok { background: var(--ok2); box-shadow: 0 0 14px rgba(45,255,178,.32); }
    .warn { background: var(--warn2); box-shadow: 0 0 14px rgba(255,176,32,.26); }
    .bad { background: var(--bad2); box-shadow: 0 0 14px rgba(255,59,92,.26); }

    [data-theme="dark"] h1{ text-shadow: var(--glow); }
    [data-theme="dark"] .kpi{ text-shadow: 0 0 18px rgba(45,255,178,.14); }

    /* Make primary button stand out */
    #btnLoad{ background: rgba(45,255,178,.12); }
    [data-theme="light"] #btnLoad{ background: rgba(37,99,235,.10); }

    /* ===== Responsive: Tablet ===== */
    @media (max-width: 900px){
      .row{
        display:grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }
      canvas{ height: 380px !important; }
    }

    /* ===== Operator Mode: Mobile factory ===== */
    @media (max-width: 600px){
      body{ padding: 10px; }

      /* sticky header */
      .title{
        position: sticky;
        top: 0;
        z-index: 50;
        padding: 10px 0;
        background: linear-gradient(180deg, var(--bg) 70%, transparent);
        backdrop-filter: blur(6px);
        border-bottom: 1px solid var(--stroke);
        margin-bottom: 10px;
      }

      .row{
        grid-template-columns: 1fr;
        gap: 10px;
      }

      .card, .chartCard{
        border-radius: var(--radius);
        padding: 14px;
      }

      input, select, button{
        height: var(--tap);
        border-radius: 14px;
      }

      .grid2{ grid-template-columns: 1fr !important; }

      .actions{
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
      }
      .actions button{ width: 100%; font-weight: 800; }

      .kpi{
        font-size: 44px;
        line-height: 1.0;
        margin-top: 10px;
      }
      .kpi small{ font-size: 16px; }

      #latestTs{ font-size: 13px; margin-top: 8px; }

      canvas{ height: 260px !important; }
      .muted{ font-size: 13px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="title">
      <h1>SCADA Dashboard</h1>

      <div class="headerRight">
        <button id="themeBtn">üåô Dark</button>

        <div class="muted">
          <span id="healthDot" class="statusDot"></span>
          <span id="healthText">checking‚Ä¶</span>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="card">
        <label>device_id</label>
        <input id="deviceId" value="dht22-01" placeholder="‡πÄ‡∏ä‡πà‡∏ô dht22-01" />
        <div class="muted" style="margin-top:8px">
          ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å: <span class="mono">/api/history?device_id=‚Ä¶&minutes=‚Ä¶</span>
        </div>

        <!-- Quick device buttons (edit names to match your devices) -->
        <div class="quick">
          <button class="chip" data-dev="dht22-01">dht22-01</button>
          <button class="chip" data-dev="dht22-02">dht22-02</button>
          <button class="chip" data-dev="dht22">dht22</button>
        </div>
      </div>

      <div class="card">
        <div class="grid2">
          <div>
            <label>‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á (minutes)</label>
            <input id="minutes" type="number" value="180" min="1" step="1" />
          </div>
          <div>
            <label>‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏ó‡∏∏‡∏Å (‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)</label>
            <input id="refreshSec" type="number" value="10" min="2" step="1" />
          </div>
        </div>

        <div class="actions">
          <button id="btnLoad">‡πÇ‡∏´‡∏•‡∏î/‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
          <button id="btnToggle">‡∏´‡∏¢‡∏∏‡∏î auto</button>
          <div class="muted" id="lastUpdate">‚Äî</div>
        </div>
      </div>

      <div class="card">
        <div class="muted">‡∏Ñ‡πà‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
        <div class="kpi" id="latestTemp">‚Äî <small>¬∞C</small></div>
        <div class="kpi" id="latestHum">‚Äî <small>%</small></div>
        <div class="muted" id="latestTs">‚Äî</div>
      </div>
    </div>

    <div class="chartCard">
      <canvas id="chart"></canvas>
      <div class="muted" id="note" style="margin-top:10px">‚Äî</div>
    </div>
  </div>

  <!-- Chart.js time adapter -->
  <script src="https://cdn.jsdelivr.net/npm/date-fns@3.6.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0"></script>

  <script>
    const $ = (id) => document.getElementById(id);

    let timer = null;
    let chart = null;

    function fmtLocal(iso) {
      if (!iso) return "‚Äî";
      const d = new Date(iso);
      return d.toLocaleString();
    }

    async function checkHealth() {
      const url = "/health";
      try {
        const res = await fetch(url, { cache: "no-store" });
        const ok = res.ok;
        $("healthDot").className = "statusDot " + (ok ? "ok" : "bad");
        $("healthText").textContent = ok ? "backend ok" : ("backend error (" + res.status + ")");
      } catch (e) {
        $("healthDot").className = "statusDot bad";
        $("healthText").textContent = "backend offline";
      }
    }

    async function loadLatest(deviceId) {
      try {
        const res = await fetch(`/api/latest?device_id=${encodeURIComponent(deviceId)}`, { cache: "no-store" });
        if (!res.ok) throw new Error("latest status " + res.status);
        const x = await res.json();
        if (!x) return;

        $("latestTemp").innerHTML = `${Number(x.temp_c ?? NaN).toFixed(2)} <small>¬∞C</small>`;
        $("latestHum").innerHTML  = `${Number(x.hum_pct ?? NaN).toFixed(2)} <small>%</small>`;
        $("latestTs").textContent = `‡πÄ‡∏ß‡∏•‡∏≤: ${fmtLocal(x.ts)} | topic: ${x.topic ?? "-"}`;
      } catch (e) {
        $("latestTs").textContent = "‡πÇ‡∏´‡∏•‡∏î latest ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ";
      }
    }

    async function loadHistory(deviceId, minutes) {
      const url = `/api/history?device_id=${encodeURIComponent(deviceId)}&minutes=${encodeURIComponent(minutes)}`;
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error("history status " + res.status);
      const arr = await res.json();
      if (!Array.isArray(arr)) throw new Error("history not array");

      arr.sort((a,b) => new Date(a.ts) - new Date(b.ts));

      const labels = arr.map(r => new Date(r.ts));
      const temp = arr.map(r => Number(r.temp_c));
      const hum  = arr.map(r => Number(r.hum_pct));

      return { labels, temp, hum, count: arr.length, firstTs: arr[0]?.ts, lastTs: arr[arr.length - 1]?.ts, url };
    }

    function setChartTheme() {
      if (!chart) return;

      const dark = document.documentElement.getAttribute("data-theme") === "dark";
      const grid = dark ? "rgba(45,255,178,.10)" : "rgba(17,24,39,.10)";
      const tick = dark ? "rgba(217,255,233,.85)" : "rgba(11,18,32,.75)";
      const border = dark ? "rgba(45,255,178,.25)" : "rgba(17,24,39,.18)";

      chart.options.scales.x.grid.color = grid;
      chart.options.scales.yTemp.grid.color = grid;
      chart.options.scales.yHum.grid.color = grid;

      chart.options.scales.x.ticks.color = tick;
      chart.options.scales.yTemp.ticks.color = tick;
      chart.options.scales.yHum.ticks.color = tick;

      chart.options.scales.x.border.color = border;
      chart.options.scales.yTemp.border.color = border;
      chart.options.scales.yHum.border.color = border;

      chart.options.plugins.legend.labels.color = tick;

      chart.data.datasets[0].borderColor = dark ? "#2dffb2" : "#2563eb";
      chart.data.datasets[1].borderColor = dark ? "#ffb020" : "#f59e0b";

      chart.update();
    }

    function ensureChart(labels, temp, hum) {
      const ctx = $("chart").getContext("2d");

      if (chart) {
        chart.data.labels = labels;
        chart.data.datasets[0].data = temp;
        chart.data.datasets[1].data = hum;
        setChartTheme();
        chart.update();
        return;
      }

      chart = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [
            {
              label: "Temperature (¬∞C)",
              data: temp,
              borderWidth: 2,
              pointRadius: 0,
              tension: 0.25,
              yAxisID: "yTemp",
              borderColor: "#2dffb2"
            },
            {
              label: "Humidity (%)",
              data: hum,
              borderWidth: 2,
              pointRadius: 0,
              tension: 0.25,
              yAxisID: "yHum",
              borderColor: "#ffb020"
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: "index", intersect: false },
          plugins: {
            legend: { position: "top" },
            tooltip: {
              callbacks: {
                title: (items) => {
                  const d = items?.[0]?.label;
                  return d ? new Date(d).toLocaleString() : "";
                }
              }
            }
          },
          scales: {
            x: { type: "time", time: { unit: "minute" } },
            yTemp: { type: "linear", position: "left", title: { display: true, text: "¬∞C" } },
            yHum:  { type: "linear", position: "right", title: { display: true, text: "%" }, grid: { drawOnChartArea: false } }
          }
        }
      });

      setChartTheme();
    }

    async function refreshOnce() {
      const deviceId = $("deviceId").value.trim();
      const minutes  = Math.max(1, Number($("minutes").value || 60));
      if (!deviceId) return;

      try {
        await checkHealth();
        await loadLatest(deviceId);

        const h = await loadHistory(deviceId, minutes);
        ensureChart(h.labels, h.temp, h.hum);

        $("lastUpdate").textContent = "‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï: " + new Date().toLocaleTimeString();
        $("note").textContent =
          `‡∏à‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${h.count} | ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤: ${fmtLocal(h.firstTs)} ‚Üí ${fmtLocal(h.lastTs)} | ${h.url}`;
      } catch (e) {
        $("note").textContent = "‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏£‡∏≤‡∏ü‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + (e?.message || e);
      }
    }

    function startAuto() {
      stopAuto();
      const sec = Math.max(2, Number($("refreshSec").value || 10));
      timer = setInterval(refreshOnce, sec * 1000);
      $("btnToggle").textContent = "‡∏´‡∏¢‡∏∏‡∏î auto";
    }

    function stopAuto() {
      if (timer) clearInterval(timer);
      timer = null;
      $("btnToggle").textContent = "‡πÄ‡∏£‡∏¥‡πà‡∏° auto";
    }

    // ===== Theme toggle =====
    const themeBtn = $("themeBtn");
    function applyTheme(theme) {
      document.documentElement.setAttribute("data-theme", theme);
      themeBtn.textContent = theme === "dark" ? "‚òÄÔ∏è Light" : "üåô Dark";
      localStorage.setItem("theme", theme);
      setChartTheme();
    }
    applyTheme(localStorage.getItem("theme") || "dark");

    themeBtn.addEventListener("click", () => {
      const cur = document.documentElement.getAttribute("data-theme");
      applyTheme(cur === "dark" ? "light" : "dark");
    });

    // ===== Quick device buttons =====
    document.querySelectorAll(".chip").forEach(btn => {
      btn.addEventListener("click", async () => {
        $("deviceId").value = btn.dataset.dev;
        await refreshOnce();
      });
    });

    // ===== Mobile: slower refresh by default (save bandwidth) =====
    if (window.matchMedia("(max-width: 600px)").matches) {
      const r = $("refreshSec");
      if (r && Number(r.value) < 20) r.value = 20;
    }

    // ===== Bind buttons =====
    $("btnLoad").addEventListener("click", async () => { await refreshOnce(); });
    $("btnToggle").addEventListener("click", () => { timer ? stopAuto() : startAuto(); });

    // First load + auto
    refreshOnce().then(startAuto);
  </script>
</body>
</html>
