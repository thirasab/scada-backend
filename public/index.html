<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SCADA Dashboard</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    /* ===== Base layout ===== */
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; padding: 16px; }
    .wrap { max-width: 1100px; margin: 0 auto; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; }
    .card {
      border: 1px solid rgba(127,127,127,.25);
      border-radius: 12px;
      padding: 12px 14px;
      flex: 1 1 260px;
      min-width: 260px;
      background: rgba(127,127,127,.06);
    }
    .title { display:flex; align-items:baseline; justify-content:space-between; gap: 10px; }
    h1 { margin: 0 0 10px 0; font-size: 20px; }
    .muted { opacity:.75; font-size: 12px; }
    label { font-size: 12px; opacity:.8; display:block; margin-bottom:6px; }
    input, select {
      width: 100%;
      padding: 10px 10px;
      border-radius: 10px;
      border: 1px solid rgba(127,127,127,.35);
      background: transparent;
      color: inherit;
      outline: none;
    }
    button {
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(127,127,127,.35);
      background: rgba(127,127,127,.12);
      color: inherit;
      cursor: pointer;
    }
    button:hover { filter: brightness(1.05); }
    .kpi { font-size: 26px; font-weight: 700; line-height: 1.1; margin-top: 6px; }
    .kpi small { font-size: 14px; font-weight: 600; opacity:.85; }
    .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 720px) { .grid2 { grid-template-columns: 1fr; } }
    .chartCard { padding: 12px 14px; border-radius: 12px; border: 1px solid rgba(127,127,127,.25); background: rgba(127,127,127,.04); }
    canvas { width: 100% !important; height: 420px !important; }
    .statusDot { display:inline-block; width:10px; height:10px; border-radius:50%; margin-right:6px; background:#999; vertical-align:middle;}
    .ok { background: #22c55e; }
    .bad { background: #ef4444; }
    .warn { background: #f59e0b; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }

    /* ===== SCADA THEME (Light + Dark) ===== */
    :root{
      color-scheme: light;
      --bg: #f6f7fb;
      --panel: rgba(255,255,255,.75);
      --panel2: rgba(255,255,255,.55);
      --stroke: rgba(17,24,39,.18);
      --text: #0b1220;
      --muted2: rgba(11,18,32,.70);

      --accent: #2563eb;
      --ok2: #16a34a;
      --warn2: #f59e0b;
      --bad2: #dc2626;

      --glow: transparent;
      --shadow: 0 8px 28px rgba(0,0,0,.08);
    }

    [data-theme="dark"]{
      color-scheme: dark;
      --bg: #05070b;
      --panel: rgba(10,14,22,.88);
      --panel2: rgba(10,14,22,.62);
      --stroke: rgba(120,255,210,.18);
      --text: #d9ffe9;
      --muted2: rgba(217,255,233,.70);

      --accent: #2dffb2;
      --ok2: #2dffb2;
      --warn2: #ffb020;
      --bad2: #ff3b5c;

      --glow: 0 0 18px rgba(45,255,178,.20), 0 0 42px rgba(45,255,178,.10);
      --shadow: 0 14px 40px rgba(0,0,0,.55);
    }

    body{
      background: radial-gradient(1200px 700px at 20% 10%, rgba(45,255,178,.05), transparent 60%),
                  radial-gradient(900px 600px at 80% 20%, rgba(255,176,32,.04), transparent 55%),
                  var(--bg);
      color: var(--text);
    }

    .muted{ opacity: 1; color: var(--muted2); }
    .mono{ color: rgba(217,255,233,.85); }

    .card, .chartCard{
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
      backdrop-filter: blur(8px);
    }

    input, select{
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,.08);
    }
    [data-theme="dark"] input,
    [data-theme="dark"] select{
      background: rgba(0,0,0,.22);
    }

    button{
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,.06);
    }
    [data-theme="dark"] button{
      background: rgba(0,0,0,.28);
      box-shadow: var(--glow);
    }
    button:hover{ filter: brightness(1.08); }

    h1{ letter-spacing: .6px; }
    [data-theme="dark"] h1{ text-shadow: var(--glow); }

    .statusDot{ background: rgba(255,255,255,.35); }
    .ok{ background: var(--ok2); box-shadow: 0 0 14px rgba(45,255,178,.35); }
    .warn{ background: var(--warn2); box-shadow: 0 0 14px rgba(255,176,32,.28); }
    .bad{ background: var(--bad2); box-shadow: 0 0 14px rgba(255,59,92,.28); }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="title">
      <h1>SCADA Dashboard</h1>

      <div style="display:flex; gap:10px; align-items:center;">
        <button id="themeBtn">üåô Dark</button>

        <div class="muted">
          <span id="healthDot" class="statusDot"></span>
          <span id="healthText">checking‚Ä¶</span>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="card">
        <label>device_id</label>
        <input id="deviceId" value="dht22-01" placeholder="‡πÄ‡∏ä‡πà‡∏ô dht22-01" />
        <div class="muted" style="margin-top:8px">
          ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å: <span class="mono">/api/history?device_id=‚Ä¶&minutes=‚Ä¶</span>
        </div>
      </div>

      <div class="card">
        <div class="grid2">
          <div>
            <label>‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á (minutes)</label>
            <input id="minutes" type="number" value="180" min="1" step="1" />
          </div>
          <div>
            <label>‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏ó‡∏∏‡∏Å (‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)</label>
            <input id="refreshSec" type="number" value="10" min="2" step="1" />
          </div>
        </div>

        <div style="display:flex; gap:10px; margin-top:12px; align-items:center;">
          <button id="btnLoad">‡πÇ‡∏´‡∏•‡∏î/‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
          <button id="btnToggle">‡∏´‡∏¢‡∏∏‡∏î auto</button>
          <div class="muted" id="lastUpdate">‚Äî</div>
        </div>
      </div>

      <div class="card">
        <div class="muted">‡∏Ñ‡πà‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
        <div class="kpi" id="latestTemp">‚Äî <small>¬∞C</small></div>
        <div class="kpi" id="latestHum">‚Äî <small>%</small></div>
        <div class="muted" id="latestTs">‚Äî</div>
      </div>
    </div>

    <div style="height:12px"></div>

    <div class="chartCard">
      <canvas id="chart"></canvas>
      <div class="muted" id="note" style="margin-top:10px">‚Äî</div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    let timer = null;
    let chart = null;

    function fmtLocal(iso) {
      if (!iso) return "‚Äî";
      const d = new Date(iso);
      return d.toLocaleString();
    }

    async function checkHealth() {
      const url = "/health"; // ‚úÖ ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö server.js
      try {
        const res = await fetch(url, { cache: "no-store" });
        const ok = res.ok;
        $("healthDot").className = "statusDot " + (ok ? "ok" : "bad");
        $("healthText").textContent = ok ? "backend ok" : ("backend error (" + res.status + ")");
      } catch (e) {
        $("healthDot").className = "statusDot bad";
        $("healthText").textContent = "backend offline";
      }
    }

    async function loadLatest(deviceId) {
      try {
        const res = await fetch(`/api/latest?device_id=${encodeURIComponent(deviceId)}`, { cache: "no-store" });
        if (!res.ok) throw new Error("latest status " + res.status);
        const x = await res.json();
        if (!x) return;

        $("latestTemp").innerHTML = `${Number(x.temp_c ?? NaN).toFixed(2)} <small>¬∞C</small>`;
        $("latestHum").innerHTML  = `${Number(x.hum_pct ?? NaN).toFixed(2)} <small>%</small>`;
        $("latestTs").textContent = `‡πÄ‡∏ß‡∏•‡∏≤: ${fmtLocal(x.ts)} | topic: ${x.topic ?? "-"}`;
      } catch (e) {
        $("latestTs").textContent = "‡πÇ‡∏´‡∏•‡∏î latest ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ";
      }
    }

    async function loadHistory(deviceId, minutes) {
      const url = `/api/history?device_id=${encodeURIComponent(deviceId)}&minutes=${encodeURIComponent(minutes)}`;
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error("history status " + res.status);
      const arr = await res.json();
      if (!Array.isArray(arr)) throw new Error("history not array");

      arr.sort((a,b) => new Date(a.ts) - new Date(b.ts));

      const labels = arr.map(r => new Date(r.ts));
      const temp = arr.map(r => Number(r.temp_c));
      const hum  = arr.map(r => Number(r.hum_pct));

      return { labels, temp, hum, count: arr.length, firstTs: arr[0]?.ts, lastTs: arr[arr.length - 1]?.ts, url };
    }

    function setChartTheme() {
      if (!chart) return;

      const dark = document.documentElement.getAttribute("data-theme") === "dark";
      const grid = dark ? "rgba(45,255,178,.10)" : "rgba(17,24,39,.10)";
      const tick = dark ? "rgba(217,255,233,.85)" : "rgba(11,18,32,.75)";
      const border = dark ? "rgba(45,255,178,.25)" : "rgba(17,24,39,.18)";

      chart.options.scales.x.grid.color = grid;
      chart.options.scales.yTemp.grid.color = grid;
      chart.options.scales.yHum.grid.color = grid;

      chart.options.scales.x.ticks.color = tick;
      chart.options.scales.yTemp.ticks.color = tick;
      chart.options.scales.yHum.ticks.color = tick;

      chart.options.scales.x.border.color = border;
      chart.options.scales.yTemp.border.color = border;
      chart.options.scales.yHum.border.color = border;

      chart.options.plugins.legend.labels.color = tick;

      chart.data.datasets[0].borderColor = dark ? "#2dffb2" : "#2563eb";
      chart.data.datasets[1].borderColor = dark ? "#ffb020" : "#f59e0b";

      chart.update();
    }

    function ensureChart(labels, temp, hum) {
      const ctx = $("chart").getContext("2d");

      if (chart) {
        chart.data.labels = labels;
        chart.data.datasets[0].data = temp;
        chart.data.datasets[1].data = hum;
        setChartTheme();
        chart.update();
        return;
      }

      chart = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [
            {
              label: "Temperature (¬∞C)",
              data: temp,
              borderWidth: 2,
              pointRadius: 0,
              tension: 0.25,
              yAxisID: "yTemp",
              borderColor: "#2dffb2"
            },
            {
              label: "Humidity (%)",
              data: hum,
              borderWidth: 2,
              pointRadius: 0,
              tension: 0.25,
              yAxisID: "yHum",
              borderColor: "#ffb020"
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: "index", intersect: false },
          plugins: {
            legend: { position: "top" },
            tooltip: {
              callbacks: {
                title: (items) => {
                  const d = items?.[0]?.label;
                  return d ? new Date(d).toLocaleString() : "";
                }
              }
            }
          },
          scales: {
            x: {
              type: "time",
              time: { unit: "minute" }
            },
            yTemp: {
              type: "linear",
              position: "left",
              title: { display: true, text: "¬∞C" }
            },
            yHum: {
              type: "linear",
              position: "right",
              title: { display: true, text: "%" },
              grid: { drawOnChartArea: false }
            }
          }
        }
      });

      setChartTheme();
    }
  </script>

  <!-- Chart.js time scale adapter -->
  <script src="https://cdn.jsdelivr.net/npm/date-fns@3.6.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0"></script>

  <script>
    // ===== Theme toggle (SCADA) =====
    const themeBtn = document.getElementById("themeBtn");

    function applyTheme(theme) {
      document.documentElement.setAttribute("data-theme", theme);
      themeBtn.textContent = theme === "dark" ? "‚òÄÔ∏è Light" : "üåô Dark";
      localStorage.setItem("theme", theme);
      setChartTheme(); // ‚úÖ update chart colors
    }

    const savedTheme = localStorage.getItem("theme") || "dark"; // default ‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏° ‡πÜ
    applyTheme(savedTheme);

    themeBtn.addEventListener("click", () => {
      const current = document.documentElement.getAttribute("data-theme");
      applyTheme(current === "dark" ? "light" : "dark");
    });

    // ===== Data refresh =====
    async function refreshOnce() {
      const deviceId = $("deviceId").value.trim();
      const minutes  = Number($("minutes").value || 60);
      if (!deviceId) return;

      try {
        await checkHealth();
        await loadLatest(deviceId);

        const h = await loadHistory(deviceId, minutes);
        ensureChart(h.labels, h.temp, h.hum);

        $("lastUpdate").textContent = "‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï: " + new Date().toLocaleTimeString();
        $("note").textContent =
          `‡∏à‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${h.count} | ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤: ${fmtLocal(h.firstTs)} ‚Üí ${fmtLocal(h.lastTs)} | ${h.url}`;
      } catch (e) {
        $("note").textContent = "‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏£‡∏≤‡∏ü‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + (e?.message || e);
      }
    }

    function startAuto() {
      stopAuto();
      const sec = Math.max(2, Number($("refreshSec").value || 10));
      timer = setInterval(refreshOnce, sec * 1000);
      $("btnToggle").textContent = "‡∏´‡∏¢‡∏∏‡∏î auto";
    }

    function stopAuto() {
      if (timer) clearInterval(timer);
      timer = null;
      $("btnToggle").textContent = "‡πÄ‡∏£‡∏¥‡πà‡∏° auto";
    }

    $("btnLoad").addEventListener("click", async () => {
      await refreshOnce();
    });

    $("btnToggle").addEventListener("click", () => {
      if (timer) stopAuto();
      else startAuto();
    });

    refreshOnce().then(startAuto);
  </script>
</body>
</html>
